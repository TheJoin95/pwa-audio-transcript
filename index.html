
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width">
  <style>
    html {
      font-family: sans-serif;
      font-size: 2em;
    }
    img {
      display: block;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <p>You can share files to this app.</p>
  <p>Or view the data for a selected file:</p>
  <input type="file" accept="foo/bar">
  <script>
    navigator.serviceWorker.register('sw.js');

    var productionTimeout = null;
    var transcriptTimeout = null;
    var credentials = "thejoin:qbumUEjjVR2bicv";
    
    function displayImage(file) {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = () => {
        URL.revokeObjectURL(url);
      };
      img.src = url;
      document.body.append(img);
    }

    function getTranscriptFile(url) {
      var xhr = new XMLHttpRequest();
      xhr.onload = function(e) {
        if(this.readyState === 4 && this.status == 200) {
          clearInterval(transcriptTimeout);
          console.log(e.target);
          var jsonResponse = JSON.parse(e.target.responseText);
          alert(jsonResponse[0]['text']);
        }
      };
      xhr.open("GET",'https://cors-anywhere.herokuapp.com/' + url,true);
      xhr.setRequestHeader("Authorization", "Basic " + btoa(credentials));
      xhr.send();
    }

    function getProductionFile(uuid) {
      var xhr = new XMLHttpRequest();
      xhr.onload=function(e) {
        if(this.readyState === 4) {
          var jsonResponse = JSON.parse(e.target.responseText);
          if (jsonResponse['data']['output_files'] !== undefined) {
            for(let key in jsonResponse['data']['output_files']) {
              if (jsonResponse['data']['output_files'][key]['format'] == 'speech' && jsonResponse['data']['output_files'][key]['download_url'] !== null) {
                clearInterval(productionTimeout);
                transcriptTimeout = setInterval(function () {
                  getTranscriptFile(jsonResponse['data']['output_files'][key]['download_url']);
                }, 2000);
                return true;
              }
            }
          }
        }
      };
      xhr.open("GET","https://auphonic.com/api/production/" + uuid + ".json",true);
      xhr.setRequestHeader("Authorization", "Basic " + btoa(credentials));
      xhr.send();
    }
    
    function displayFile(file) {
      const ul = document.createElement('ul');
      document.body.append(ul);

      for (const prop of ['name', 'size', 'type']) {
        const li = document.createElement('li');
        li.textContent = `${prop} = ${file[prop]}`;
        ul.append(li);
      }

      var frmData = new FormData();
      frmData.append('input_file', file);
      frmData.append('preset', '7QEfU3XriStwVNWdrHf984');
      frmData.append('title', 'transcript - ' + ((new Date()).getTime()));
      frmData.append('action', 'start');

      var xhr = new XMLHttpRequest();
      xhr.onload=function(e) {
        if(this.readyState === 4) {
          var jsonResponse = JSON.parse(e.target.responseText);
          productionTimeout = setInterval(function () {
            getProductionFile(jsonResponse['data']['uuid']);
          }, 2500);
        }
      };
      xhr.open("POST","https://auphonic.com/api/simple/productions.json",true);
      xhr.setRequestHeader("Authorization", "Basic " + btoa(credentials));
      xhr.send(frmData);
    }
    
    navigator.serviceWorker.onmessage = (event) => {
      const file = event.data.file;
      displayFile(file);
    };
    
    document.querySelector('input[type=file]').onchange = (event) => {
      displayFile(event.target.files[0]);
    };
  </script>
</body>
</html>